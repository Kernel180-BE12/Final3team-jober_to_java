name: CI/CD Spring Boot JAR to EC2

on:
    push:
        branches: ["main", "chore/github-actions-pipeline"]

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: '21'
                  distribution: 'temurin'

            - name: Build with Maven
              run: mvn clean package -DskipTests

            - name: Upload JAR to EC2
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: "target/*.jar,scripts/*"
                  target: "/home/ubuntu/"

            # CRLF → LF, 실행권한, JAR 존재 체크 (준비 단계)
            - name: Prepare scripts on EC2
              uses: appleboy/ssh-action@v0.1.6
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      set -e
                      sed -i 's/\r$//' /home/ubuntu/scripts/*.sh || true
                      chmod +x /home/ubuntu/scripts/*.sh
                      ls -al /home/ubuntu/target/*.jar

            # stop.sh만 별도 실행 (세션 끊겨도 파이프라인은 진행)
            - name: Stop application on EC2 (allow disconnect)
              uses: appleboy/ssh-action@v0.1.6
              continue-on-error: true
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      /home/ubuntu/scripts/stop.sh || true

            # start.sh 실행 + 환경변수 주입 + 헬스 확인
            - name: Start application on EC2
              uses: appleboy/ssh-action@v0.1.6
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      set -euo pipefail
                      
                      # ===== 환경변수 세팅 (Actions Secrets → 프로세스 환경) =====
                      export DB_URL='${{ secrets.DB_URL }}'
                      export DB_USER='${{ secrets.DB_USER }}'
                      export DB_PASS='${{ secrets.DB_PASS }}'
                      export JWT_SECRET='${{ secrets.JWT_SECRET }}'
                      export OTP_PEPPER='${{ secrets.OTP_PEPPER }}'
                      export REFRESH_PEPPER='${{ secrets.REFRESH_PEPPER }}'
                      export VERIFY_BASE_URL='${{ secrets.VERIFY_BASE_URL }}'
                      export AI_BASE_URL='${{ secrets.AI_BASE_URL }}'
                      
                      export CORS_ALLOWED_ORIGINS='${{ secrets.CORS_ALLOWED_ORIGINS }}'
                      export APP_COOKIE_SAMESITE='${{ secrets.APP_COOKIE_SAMESITE }}'
                      export APP_COOKIE_SECURE='${{ secrets.APP_COOKIE_SECURE }}'
                      export APP_COOKIE_MAX_AGE='${{ secrets.APP_COOKIE_MAX_AGE }}'
                      export APP_COOKIE_PATH='${{ secrets.APP_COOKIE_PATH }}'
                      export CSRF_ENABLED='${{ secrets.CSRF_ENABLED }}'
                      
                      /home/ubuntu/scripts/start.sh
                      
                      # 간단 헬스 체크
                      sleep 2
                      ss -ltnp | grep :8080 || true
                      tail -n 150 /home/ubuntu/jober-app.log || true
