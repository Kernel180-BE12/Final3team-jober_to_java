name: CI/CD Spring Boot JAR to EC2

on:
  push:
    branches: ["main", "chore/github-actions-pipeline"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package

      - name: Upload JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "target/*.jar,scripts/*"
          target: "/home/ubuntu/"

      - name: Prepare scripts on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            sed -i 's/\r$//' /home/ubuntu/scripts/*.sh || true
            chmod +x /home/ubuntu/scripts/*.sh
            ls -al /home/ubuntu/target/*.jar

      - name: Stop application on EC2 (allow disconnect)
        uses: appleboy/ssh-action@v1.0.0
        continue-on-error: true
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            /home/ubuntu/scripts/stop.sh || true

      - name: Start application on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            export JWT_SECRET='${{ secrets.JWT_SECRET }}'
            export REFRESH_PEPPER='${{ secrets.REFRESH_PEPPER }}'
            export DB_URL='${{ secrets.DB_URL }}'
            export DB_USER='${{ secrets.DB_USER }}'
            export DB_PASS='${{ secrets.DB_PASS }}'
            export OTP_PEPPER='${{ secrets.OTP_PEPPER }}'
            export VERIFY_BASE_URL='${{ secrets.VERIFY_BASE_URL }}'
            export AI_BASE_URL='${{ secrets.AI_BASE_URL }}'
            export CORS_ALLOWED_ORIGINS='${{ secrets.CORS_ALLOWED_ORIGINS }}'
            export APP_COOKIE_SAMESITE='${{ secrets.APP_COOKIE_SAMESITE }}'
            export APP_COOKIE_SECURE='${{ secrets.APP_COOKIE_SECURE }}'
            export APP_COOKIE_MAX_AGE='${{ secrets.APP_COOKIE_MAX_AGE }}'
            export APP_COOKIE_PATH='${{ secrets.APP_COOKIE_PATH }}'
            export CSRF_ENABLED='${{ secrets.CSRF_ENABLED }}'
            export SERVER_PORT='8080'
            
            /home/ubuntu/scripts/start.sh

      - name: Health check on EC2 (dynamic port)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            PORT="$(grep -oP 'Tomcat started on port\(s\): \K[0-9]+' /home/ubuntu/jober-app.log 2>/dev/null | tail -1 || true)"
            if [ -z "${PORT}" ]; then
              ADDR="$(sudo ss -ltnp | awk '/java/ && /LISTEN/ {print $4}' | tail -1 || true)"
              [ -n "${ADDR}" ] && PORT="${ADDR##*:}"
            fi
            [ -z "${PORT}" ] && PORT="${SERVER_PORT:-8080}"
            HOST="127.0.0.1"
            
            echo "Health check: http://${HOST}:${PORT}/actuator/health"

            for i in {1..6}; do
              if curl -fsS "http://${HOST}:${PORT}/actuator/health"; then
                echo "Health check successful!"
                tail -n 50 /home/ubuntu/jober-app.log || true
                exit 0
              fi
              echo "Health check attempt $i failed. Retrying in 10 seconds..."
              sleep 10
            done

            echo "Health check failed after multiple attempts."
            tail -n 120 /home/ubuntu/jober-app.log || true
            exit 1
