name: CI/CD Spring Boot JAR to EC2

on:
    push:
        branches: ["main", "chore/github-actions-pipeline"]

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: '21'
                  distribution: 'temurin'

            - name: Build with Maven
              run: mvn clean package -DskipTests

            - name: Upload JAR to EC2
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: "target/*.jar,scripts/*"
                  target: "/home/ubuntu/"

            - name: Restart application on EC2
              uses: appleboy/ssh-action@v0.1.6
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script_stop: true
                  script: |
                      set -euo pipefail
                      
                      # 윈도우 줄바꿈 대응(CRLF -> LF)
                      sed -i 's/\r$//' /home/ubuntu/scripts/*.sh
                      
                      chmod +x /home/ubuntu/scripts/*.sh
                      
                      # ===== 환경변수 세팅 (Actions Secrets → 프로세스 환경) =====
                      export DB_URL='${{ secrets.DB_URL }}'
                      export DB_USER='${{ secrets.DB_USER }}'
                      export DB_PASS='${{ secrets.DB_PASS }}'
                      export JWT_SECRET='${{ secrets.JWT_SECRET }}'
                      export OTP_PEPPER='${{ secrets.OTP_PEPPER }}'
                      export REFRESH_PEPPER='${{ secrets.REFRESH_PEPPER }}'
                      export VERIFY_BASE_URL='${{ secrets.VERIFY_BASE_URL }}'
                      export AI_BASE_URL='${{ secrets.AI_BASE_URL }}'
                      
                      export CORS_ALLOWED_ORIGINS='${{ secrets.CORS_ALLOWED_ORIGINS }}'
                      export APP_COOKIE_SAMESITE='${{ secrets.APP_COOKIE_SAMESITE }}'
                      export APP_COOKIE_SECURE='${{ secrets.APP_COOKIE_SECURE }}'
                      export APP_COOKIE_MAX_AGE='${{ secrets.APP_COOKIE_MAX_AGE }}'
                      export APP_COOKIE_PATH='${{ secrets.APP_COOKIE_PATH }}'
                      export CSRF_ENABLED='${{ secrets.CSRF_ENABLED }}'
                      
                      # ===== 앱 재시작 =====
                      /home/ubuntu/scripts/stop.sh || true
                      sleep 3
                      /home/ubuntu/scripts/start.sh
                      
                      # (선택) 간단 확인
                      sleep 2
                      ss -ltnp | grep :8080 || true
                      tail -n 120 /home/ubuntu/jober-app.log || true
